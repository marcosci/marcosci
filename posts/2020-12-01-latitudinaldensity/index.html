<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Spatial density latitudinal lines for COVID-19 | Marco Sciaini</title>
  <meta name="description" content="Hi there, I&#39;m Marco. Nice to meet you! I am a Data Analyst and Geospatial Enthusiast. I build custom statistical models, data visualisations, maps and dashboards. Check out my toolbox, thoughts and projects below!">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Spatial density latitudinal lines for COVID-19" />
<meta property="og:description" content="Background Inspired by James Cheshire&rsquo;s Population Lines Print and Ryan Brideau, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.
The data comes from the covid19germany package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcosci.github.io/posts/2020-12-01-latitudinaldensity/" />
<meta property="article:published_time" content="2020-11-30T09:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-30T09:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spatial density latitudinal lines for COVID-19"/>
<meta name="twitter:description" content="Background Inspired by James Cheshire&rsquo;s Population Lines Print and Ryan Brideau, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.
The data comes from the covid19germany package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://marcosci.github.io/css/style-light.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://marcosci.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://marcosci.github.io/posts/2020-11-06-rstudiovscode/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&text=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&is_video=false&description=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&body=Check out this article: https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&name=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&description=Background%20Inspired%20by%20James%20Cheshire%26rsquo%3bs%20Population%20Lines%20Print%20and%20Ryan%20Brideau%2c%20I%20wanted%20to%20track%20the%20spatial%20Pattern%20of%20the%20COVID-19%20in%20Germany%20over%20time.%20This%20map%20shows%20the%20density%20of%20confirmed%20cases%20COVID-19%20cases%20by%20latitude.%0aThe%20data%20comes%20from%20the%20covid19germany%20package%2c%20which%20was%20developed%20in%20the%20context%20of%20the%20%23WirvsVirus%20hackathon.%20The%20package%20loads%20the%20data%20from%20the%20Bundesamt%20f%c3%bcr%20Kartographie%20und%20Geod%c3%a4sie%20as%20well%20as%20the%20Robert%20Koch%20Institut.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&t=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#come-along">Come along!</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#turning-polygons-in-raster">Turning polygons in raster</a></li>
<li><a href="#visualize-it">Visualize it!</a>
<ul>
<li><a href="#data-cleaning">Data cleaning</a></li>
<li><a href="#gganimate">gganimate</a></li>
<li><a href="#ggplot">ggplot</a></li>
</ul></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Spatial density latitudinal lines for COVID-19
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2020-11-30 09:00:00 &#43;0000 UTC" itemprop="datePublished">2020-11-30</time>
          
        </div>
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/tutorial">tutorial</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/r" rel="tag">R</a>
            
             ,  
            <a class="tag-link" href="/tags/geospatial" rel="tag">geospatial</a>
            
             ,  
            <a class="tag-link" href="/tags/visualisation" rel="tag">visualisation</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      

<h2 id="background">Background</h2>

<p><img src="https://github.com/indblik-io/covidlines/blob/main/covidlines.png?raw=true" alt="covidlines.png" /></p>

<p>Inspired by James Cheshire&rsquo;s <a href="https://spatial.ly/2014/08/population-lines/">Population Lines Print</a> and <a href="https://www.whackdata.com/2014/08/04/line-graphs-parallel-processing-r/">Ryan Brideau</a>, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.</p>

<p>The data comes from the <a href="https://github.com/nevrome/covid19germany">covid19germany</a> package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut.</p>

<p>With the code in this project, you can either visualize the COVID-19 density for a single day or animte a certain timespan via gganimate. Since the spatial nature of our data, this animation &hellip; will take some time and computing resources.</p>

<h2 id="come-along">Come along!</h2>

<h3 id="setup">Setup</h3>

<p>First, we will need a bunch of R packages - tidyverse for our data wrangling, covid19germany for the COVID-19 data, sf, stars, landscapetools and fasterize for our spatial data wrangling,  and gganimate and extrafont to enrich our vis magic!</p>

<pre><code class="language-r">library(tidyverse)
library(covid19germany)
library(sf)
library(stars)
library(landscapetools)
library(fasterize)
library(gganimate)
library(extrafont)
</code></pre>

<p>extrafont allows us to use our systemfonts, later I assume that you have the Google font Mono installed. Otherwise, ggplot will fall back to a default font.</p>

<pre><code class="language-r">extrafont::loadfonts(quiet = TRUE)
</code></pre>

<h3 id="turning-polygons-in-raster">Turning polygons in raster</h3>

<p>Then, we will load timeseries data for COVID-19 on NUTS-3 level for Germany and merge it with a GADM polygon to make it spatial.
To be able to plot our spatial density lines, we have to turn our polygons into a raster. For this, we loop through each date in our dataset, make a complete dataset (fill zero cases which are NA in our data with a 0 - meaning zero cases, which is true for this type of data). We then standardize by area since some NUTS-3 regions are a lot bigger than others.</p>

<p>Lastly, we coerce our freshly cleanded polygon for each date into raster and this raster immediately into a tibble with x , y, z and time as columns. We will use the x, y and z to draw our lines and the date for the animation.</p>

<pre><code class="language-r"># load covid and spatial data ----
cov_df &lt;- covid19germany::get_RKI_timeseries()

con &lt;- url(&quot;https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_3_sf.rds&quot;)
germany_sf &lt;- readRDS(con)

# data cleaning ----
## clean weird naming of county names in covid dataframe
cov_df$Landkreis &lt;- str_sub(cov_df$Landkreis, 4) 

## make covid data spatial 
germany_cov &lt;- left_join(germany_sf, cov_df, by = c(&quot;NAME_3&quot; = &quot;Landkreis&quot;))

## group by date and county and summarise number of new confirmed cases
germany_cov_clean &lt;- germany_cov %&gt;%
  group_by(Date, NAME_3) %&gt;%
  summarise(SUM = sum(NumberNewTestedIll))

# data transformation ---
spatial_data &lt;- map_dfr(na.omit(unique(germany_cov_clean$Date)), function(id_date){
  
  # filter for specific date
  cov_intermed &lt;- germany_cov_clean %&gt;% 
    filter(Date == as.Date(id_date)) 
  
  # since we only have polygons where NewIll &gt; 0, we need to join the &quot;empty&quot; ones
  cov_intermed &lt;- suppressWarnings(st_join(germany_sf, cov_intermed))
  
  # standardize by area
  cov_intermed$SUM &lt;- (cov_intermed$SUM / st_area(cov_intermed))
  
  # and since &quot;empty&quot; actually means 0, we are going to do this
  cov_intermed$SUM &lt;- cov_intermed$SUM %&gt;% replace_na(0)
  
  # turn the polygons to a raster and coerce this raster to a tibble
  cov_r &lt;- raster(cov_intermed, res = 0.03320453)
  cov_intermed &lt;- fasterize(cov_intermed, cov_r, field = &quot;SUM&quot;, fun=&quot;sum&quot;) %&gt;% 
    landscapetools::util_raster2tibble()
  
  # and get the naming right
  cov_intermed &lt;- cov_intermed %&gt;%
    rename(lng = x, lat =y, value = z) #%&gt;% 
  
  cov_intermed$date &lt;- as.Date(id_date)
  cov_intermed
  
})
</code></pre>

<h3 id="visualize-it">Visualize it!</h3>

<h4 id="data-cleaning">Data cleaning</h4>

<p>There is something wrong with the data before the 08th of march apparently, two dates have the same numer of newly positve tested person &hellip; which causes a weird error from gganimate, so we start with this date.</p>

<pre><code class="language-r">spatial_data_df &lt;- spatial_data %&gt;% 
  filter(date &gt; as.Date(&quot;2020-03-08&quot;))
</code></pre>

<p>We will use the five German cities Berlin, Frankfurt, Munich, Hamburg and Dortmund as points in space to give some spatial grasp to our data. Hence, we filter our sf object for Germany and repeat our data prepping steps. Lastly, we write it as a new column in our spatial_data_df object to use it later as a unique layer in our ggplot.</p>

<pre><code class="language-r">aoi &lt;- c(&quot;Berlin&quot;, &quot;Frankfurt am Main&quot;, &quot;München&quot;, &quot;Hamburg&quot;, &quot;Dortmund&quot;)

aoi_poly &lt;- germany_sf %&gt;% 
  filter(NAME_2 %in% aoi)

aoi_poly$group_id &lt;- aoi_poly %&gt;% 
  group_by(NAME_2) %&gt;% 
  group_indices()

aoi_poly &lt;- st_join(germany_sf, aoi_poly)
aoi_poly$group_id &lt;- aoi_poly$group_id %&gt;% replace_na(0)

aoi_r &lt;- raster(aoi_poly, res = 0.03320453)
aoi_r &lt;- fasterize(aoi_poly, aoi_r, field = &quot;group_id&quot;, fun = &quot;first&quot;) %&gt;% 
  landscapetools::util_raster2tibble()

aoi_r &lt;- purrr::map_dfr(seq_len(length(unique(spatial_data_df$date))), ~aoi_r)

spatial_data_df$city &lt;- aoi_r$z
</code></pre>

<p>We then define the colors we are going to use for our arrows indicating the position of the fice cities we specified and define the geometry of these arrows.</p>

<pre><code class="language-r">line_color = c('#fba298', &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;)

arrow &lt;- tibble(x =    c(230, 245, 127, 130, 173, 185, 82, 50, 44,  25), 
                xend = c(245, 260, 130, 133, 185, 229, 50, 29, 25,  14), 
                y =    c(160, 170, 192, 220, 30,  34,  84, 84, 127, 127), 
                yend = c(170, 170, 220, 224, 34,  34,  84, 50, 127, 148))
</code></pre>

<h4 id="gganimate">gganimate</h4>

<p>Turning this into a beautiful animation over time becomes now a breeze with gganimate &hellip;</p>

<pre><code class="language-r">p1 &lt;- ggplot(spatial_data_df, aes(lng, lat + 6*(value/max(value, na.rm=TRUE)))) +
  geom_line(size = 0.35,
            alpha=0.6,
            aes(group = lat, color = factor(city)),
            na.rm=TRUE) +
  ggthemes::theme_map(base_family = &quot;Overpass Mono&quot;) +
  labs(
    title = 'Day: {frame_time}',
    subtitle = &quot;Shown is the number of new confirmed COVID-19 cases for each day since March, 2020.&quot;,
    caption = &quot;Visualization by Marco Sciaini • Data by RKI&quot;
  ) +
  transition_time(date) +
  shadow_wake(wake_length = 0.1, colour = '#5A3E37')  +
  theme(plot.background = element_rect(fill = &quot;#e6eaeb&quot;, &quot;#e6eaeb&quot;),
        plot.title = element_text(size = 16), 
        plot.subtitle = element_text(size = 12)) +
  scale_color_manual(values = line_color, guide = &quot;none&quot;) +
  geom_segment(data = arrow, 
               aes(x = x, xend = xend, y = y, yend = yend),
               size = 0.1,
               alpha = 0.7) +
  annotate(&quot;text&quot;, x = 270, y = 170, label = &quot;Berlin&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 240, y = 34, label = &quot;Munich&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 30, y = 48, label = &quot;Frankfurt&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 15, y = 150, label = &quot;Dortmund&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 144, y = 225, label = &quot;Hamburg&quot;, size = 2.7, family = &quot;Overpass Mono&quot;)

gganimate::animate(p1,
                   render = gifski_renderer(),
                   nframes = length(unique(spatial_data_df$date)),
                   width= 3458,
                   height= 3858,
                   duration = 15,
                   res = 300)

anim_save(&quot;covidlines.gif&quot;)
</code></pre>

<p>Caveat: This becomes a memory monster &hellip; in late November, this was 43 gb in memory.</p>

<h4 id="ggplot">ggplot</h4>

<p>If we want to have look at specific dates, this becomes just the same chunk as above without the gganimate functions:</p>

<pre><code class="language-r"># plot a single day ----
id_date = &quot;2020-10-05&quot;

spatial_data_df %&gt;% 
  filter(date == as.Date(id_date)) %&gt;% 
  ggplot(aes(lng, lat + 25*(value/max(value, na.rm = TRUE)))) +
  geom_line(size = 0.35,
            alpha=0.6,
            aes(group = lat, color = factor(city)),
            na.rm=TRUE) +
  ggthemes::theme_map(base_family = &quot;Overpass Mono&quot;) +
  labs(
    title = paste(&quot;Day:&quot;, id_date), 
    subtitle = &quot;Shown is the number of new confirmed COVID-19 as latitudinal density.&quot;,
    caption = &quot;Visualization by Marco Sciaini • Data by RKI&quot;
  ) +
  theme(plot.background = element_rect(fill = &quot;#e6eaeb&quot;, &quot;#e6eaeb&quot;)) +
  scale_color_manual(values = line_color, guide = &quot;none&quot;) +
  geom_segment(data = arrow, 
               aes(x = x, xend = xend, y = y, yend = yend),
               size = 0.1,
               alpha = 0.7) +
  annotate(&quot;text&quot;, x = 270, y = 170, label = &quot;Berlin&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 240, y = 34, label = &quot;Munich&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 30, y = 48, label = &quot;Frankfurt&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 15, y = 150, label = &quot;Dortmund&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 144, y = 225, label = &quot;Hamburg&quot;, size = 2.7, family = &quot;Overpass Mono&quot;)

ggsave(&quot;covidlines.png&quot;, width = 6.58, height = 8.58)
</code></pre>

<h2 id="summary">Summary</h2>

<p>Turning COVID-19 timeseries data into a spatial animation with a strong hinche of Joy Division solely relying on R Stats tools? No problem &hellip; It is just awesome that there is an R package for everything!</p>

<p>If you have any feedback on code/visualisition - get in touch, would love to chat about it. Otherwise, here is the full code to get to the animation or static plot:</p>

<pre><code class="language-r">library(tidyverse)
library(sf)
library(covid19germany)
library(stars)
library(gganimate)
library(fasterize)
library(extrafont)
library(landscapetools)

# load font ----
extrafont::loadfonts(quiet = TRUE)

# load covid and spatial data ----
cov_df &lt;- covid19germany::get_RKI_timeseries()

con &lt;- url(&quot;https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_3_sf.rds&quot;)
germany_sf &lt;- readRDS(con)

# data cleaning ----
## clean weird naming of county names in covid dataframe
cov_df$Landkreis &lt;- str_sub(cov_df$Landkreis, 4) 

## make covid data spatial 
germany_cov &lt;- left_join(germany_sf, cov_df, by = c(&quot;NAME_3&quot; = &quot;Landkreis&quot;))

## group by date and county and summarise number of new confirmed cases
germany_cov_clean &lt;- germany_cov %&gt;%
  group_by(Date, NAME_3) %&gt;%
  summarise(SUM = sum(NumberNewTestedIll))

# data transformation ---
spatial_data &lt;- map_dfr(na.omit(unique(germany_cov_clean$Date)), function(id_date){
  
  # filter for specific date
  cov_intermed &lt;- germany_cov_clean %&gt;% 
    filter(Date == as.Date(id_date)) 
  
  # since we only have polygons where NewIll &gt; 0, we need to join the &quot;empty&quot; ones
  cov_intermed &lt;- suppressWarnings(st_join(germany_sf, cov_intermed))
  
  # standardize by area
  cov_intermed$SUM &lt;- (cov_intermed$SUM / st_area(cov_intermed))
  
  # and since &quot;empty&quot; actually means 0, we are going to do this
  cov_intermed$SUM &lt;- cov_intermed$SUM %&gt;% replace_na(0)
  
  # turn the polygons to a raster and coerce this raster to a tibble
  cov_r &lt;- raster(cov_intermed, res = 0.03320453)
  cov_intermed &lt;- fasterize(cov_intermed, cov_r, field = &quot;SUM&quot;, fun=&quot;sum&quot;) %&gt;% 
    landscapetools::util_raster2tibble()
  
  # and get the naming right
  cov_intermed &lt;- cov_intermed %&gt;%
    rename(lng = x, lat =y, value = z) #%&gt;% 
  
  cov_intermed$date &lt;- as.Date(id_date)
  cov_intermed
  
})

# animate as gif ----
## there is something wrong with the data before the 08th of march
## apparently, two dates have the same numer of newly positve tested person
## ... which causes a weird error from gganimate, so we start with this date
spatial_data_df &lt;- spatial_data %&gt;% 
  filter(date &gt; as.Date(&quot;2020-03-08&quot;))


aoi &lt;- c(&quot;Berlin&quot;, &quot;Frankfurt am Main&quot;, &quot;München&quot;, &quot;Hamburg&quot;, &quot;Dortmund&quot;)

aoi_poly &lt;- germany_sf %&gt;% 
  filter(NAME_2 %in% aoi)

aoi_poly$group_id &lt;- aoi_poly %&gt;% 
  group_by(NAME_2) %&gt;% 
  group_indices()

aoi_poly &lt;- st_join(germany_sf, aoi_poly)
aoi_poly$group_id &lt;- aoi_poly$group_id %&gt;% replace_na(0)

aoi_r &lt;- raster(aoi_poly, res = 0.03320453)
aoi_r &lt;- fasterize(aoi_poly, aoi_r, field = &quot;group_id&quot;, fun = &quot;first&quot;) %&gt;% 
  landscapetools::util_raster2tibble()

aoi_r &lt;- purrr::map_dfr(seq_len(length(unique(spatial_data_df$date))), ~aoi_r)

spatial_data_df$city &lt;- aoi_r$z


line_color = c('#fba298', &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;, &quot;#f84d39&quot;)

arrow &lt;- tibble(x =    c(230, 245, 127, 130, 173, 185, 82, 50, 44,  25), 
                xend = c(245, 260, 130, 133, 185, 229, 50, 29, 25,  14), 
                y =    c(160, 170, 192, 220, 30,  34,  84, 84, 127, 127), 
                yend = c(170, 170, 220, 224, 34,  34,  84, 50, 127, 148))

p1 &lt;- ggplot(spatial_data_df, aes(lng, lat + 6*(value/max(value, na.rm=TRUE)))) +
  geom_line(size = 0.35,
            alpha=0.6,
            aes(group = lat, color = factor(city)),
            na.rm=TRUE) +
  ggthemes::theme_map(base_family = &quot;Overpass Mono&quot;) +
  labs(
    title = 'Day: {frame_time}',
    subtitle = &quot;Shown is the number of new confirmed COVID-19 cases for each day since March, 2020.&quot;,
    caption = &quot;Visualization by Marco Sciaini • Data by RKI&quot;
  ) +
  transition_time(date) +
  shadow_wake(wake_length = 0.1, colour = '#5A3E37')  +
  theme(plot.background = element_rect(fill = &quot;#e6eaeb&quot;, &quot;#e6eaeb&quot;),
        plot.title = element_text(size = 16), 
        plot.subtitle = element_text(size = 12)) +
  scale_color_manual(values = line_color, guide = &quot;none&quot;) +
  geom_segment(data = arrow, 
               aes(x = x, xend = xend, y = y, yend = yend),
               size = 0.1,
               alpha = 0.7) +
  annotate(&quot;text&quot;, x = 270, y = 170, label = &quot;Berlin&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 240, y = 34, label = &quot;Munich&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 30, y = 48, label = &quot;Frankfurt&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 15, y = 150, label = &quot;Dortmund&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 144, y = 225, label = &quot;Hamburg&quot;, size = 2.7, family = &quot;Overpass Mono&quot;)

gganimate::animate(p1,
                   render = gifski_renderer(),
                   nframes = length(unique(spatial_data_df$date)),
                   width= 3458,
                   height= 3858,
                   duration = 15,
                   res = 300)

anim_save(&quot;covidlines.gif&quot;)


# plot a single day ----
id_date = &quot;2020-10-05&quot;

spatial_data_df %&gt;% 
  filter(date == as.Date(id_date)) %&gt;% 
  ggplot(aes(lng, lat + 25*(value/max(value, na.rm = TRUE)))) +
  geom_line(size = 0.35,
            alpha=0.6,
            aes(group = lat, color = factor(city)),
            na.rm=TRUE) +
  ggthemes::theme_map(base_family = &quot;Overpass Mono&quot;) +
  labs(
    title = paste(&quot;Day:&quot;, id_date), 
    subtitle = &quot;Shown is the number of new confirmed COVID-19 as latitudinal density.&quot;,
    caption = &quot;Visualization by Marco Sciaini • Data by RKI&quot;
  ) +
  theme(plot.background = element_rect(fill = &quot;#e6eaeb&quot;, &quot;#e6eaeb&quot;)) +
  scale_color_manual(values = line_color, guide = &quot;none&quot;) +
  geom_segment(data = arrow, 
               aes(x = x, xend = xend, y = y, yend = yend),
               size = 0.1,
               alpha = 0.7) +
  annotate(&quot;text&quot;, x = 270, y = 170, label = &quot;Berlin&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 240, y = 34, label = &quot;Munich&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 30, y = 48, label = &quot;Frankfurt&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 15, y = 150, label = &quot;Dortmund&quot;, size = 2.7, family = &quot;Overpass Mono&quot;) +
  annotate(&quot;text&quot;, x = 144, y = 225, label = &quot;Hamburg&quot;, size = 2.7, family = &quot;Overpass Mono&quot;)

ggsave(&quot;covidlines.png&quot;, width = 6.58, height = 8.58)
</code></pre>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#come-along">Come along!</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#turning-polygons-in-raster">Turning polygons in raster</a></li>
<li><a href="#visualize-it">Visualize it!</a>
<ul>
<li><a href="#data-cleaning">Data cleaning</a></li>
<li><a href="#gganimate">gganimate</a></li>
<li><a href="#ggplot">ggplot</a></li>
</ul></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&text=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&is_video=false&description=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&body=Check out this article: https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&name=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&description=Background%20Inspired%20by%20James%20Cheshire%26rsquo%3bs%20Population%20Lines%20Print%20and%20Ryan%20Brideau%2c%20I%20wanted%20to%20track%20the%20spatial%20Pattern%20of%20the%20COVID-19%20in%20Germany%20over%20time.%20This%20map%20shows%20the%20density%20of%20confirmed%20cases%20COVID-19%20cases%20by%20latitude.%0aThe%20data%20comes%20from%20the%20covid19germany%20package%2c%20which%20was%20developed%20in%20the%20context%20of%20the%20%23WirvsVirus%20hackathon.%20The%20package%20loads%20the%20data%20from%20the%20Bundesamt%20f%c3%bcr%20Kartographie%20und%20Geod%c3%a4sie%20as%20well%20as%20the%20Robert%20Koch%20Institut.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&t=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Marco Sciaini 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
