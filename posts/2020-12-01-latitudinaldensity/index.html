<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Spatial density latitudinal lines for COVID-19 | Marco Sciaini</title>
  <meta name="description" content="Hi there, I&#39;m Marco. Nice to meet you! I am a Data Analyst and Geospatial Enthusiast. I build custom statistical models, data visualisations, maps and dashboards. Check out my toolbox, thoughts and projects below!">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Spatial density latitudinal lines for COVID-19" />
<meta property="og:description" content="Background Inspired by James Cheshire&rsquo;s Population Lines Print and Ryan Brideau, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.
The data comes from the covid19germany package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://marcosci.github.io/posts/2020-12-01-latitudinaldensity/" />
<meta property="article:published_time" content="2020-11-30T09:00:00+00:00" />
<meta property="article:modified_time" content="2020-11-30T09:00:00+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Spatial density latitudinal lines for COVID-19"/>
<meta name="twitter:description" content="Background Inspired by James Cheshire&rsquo;s Population Lines Print and Ryan Brideau, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.
The data comes from the covid19germany package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://marcosci.github.io/css/style-light.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://marcosci.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://marcosci.github.io/posts/2020-11-06-rstudiovscode/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&text=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&is_video=false&description=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&body=Check out this article: https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&name=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&description=Background%20Inspired%20by%20James%20Cheshire%26rsquo%3bs%20Population%20Lines%20Print%20and%20Ryan%20Brideau%2c%20I%20wanted%20to%20track%20the%20spatial%20Pattern%20of%20the%20COVID-19%20in%20Germany%20over%20time.%20This%20map%20shows%20the%20density%20of%20confirmed%20cases%20COVID-19%20cases%20by%20latitude.%0aThe%20data%20comes%20from%20the%20covid19germany%20package%2c%20which%20was%20developed%20in%20the%20context%20of%20the%20%23WirvsVirus%20hackathon.%20The%20package%20loads%20the%20data%20from%20the%20Bundesamt%20f%c3%bcr%20Kartographie%20und%20Geod%c3%a4sie%20as%20well%20as%20the%20Robert%20Koch%20Institut.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&t=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#come-along">Come along!</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#turning-polygons-in-raster">Turning polygons in raster</a></li>
<li><a href="#visualize-it">Visualize it!</a>
<ul>
<li><a href="#data-cleaning">Data cleaning</a></li>
<li><a href="#gganimate">gganimate</a></li>
<li><a href="#ggplot">ggplot</a></li>
</ul></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Spatial density latitudinal lines for COVID-19
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2020-11-30 09:00:00 &#43;0000 UTC" itemprop="datePublished">2020-11-30</time>
          
        </div>
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/tutorial">tutorial</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/r" rel="tag">R</a>
            
             ,  
            <a class="tag-link" href="/tags/geospatial" rel="tag">geospatial</a>
            
             ,  
            <a class="tag-link" href="/tags/visualisation" rel="tag">visualisation</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      

<h2 id="background">Background</h2>

<p><img src="https://github.com/indblik-io/covidlines/blob/main/covidlines.png?raw=true" alt="covidlines.png" /></p>

<p>Inspired by James Cheshire&rsquo;s <a href="https://spatial.ly/2014/08/population-lines/">Population Lines Print</a> and <a href="https://www.whackdata.com/2014/08/04/line-graphs-parallel-processing-r/">Ryan Brideau</a>, I wanted to track the spatial Pattern of the COVID-19 in Germany over time. This map shows the density of confirmed cases COVID-19 cases by latitude.</p>

<p>The data comes from the <a href="https://github.com/nevrome/covid19germany">covid19germany</a> package, which was developed in the context of the #WirvsVirus hackathon. The package loads the data from the Bundesamt für Kartographie und Geodäsie as well as the Robert Koch Institut.</p>

<p>With the code in this project, you can either visualize the COVID-19 density for a single day or animte a certain timespan via gganimate. Since the spatial nature of our data, this animation &hellip; will take some time and computing resources.</p>

<h2 id="come-along">Come along!</h2>

<h3 id="setup">Setup</h3>

<p>First, we will need a bunch of R packages - tidyverse for our data wrangling, covid19germany for the COVID-19 data, sf, stars, landscapetools and fasterize for our spatial data wrangling,  and gganimate and extrafont to enrich our vis magic!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#f92672">library</span>(tidyverse)
<span style="color:#f92672">library</span>(covid19germany)
<span style="color:#f92672">library</span>(sf)
<span style="color:#f92672">library</span>(stars)
<span style="color:#f92672">library</span>(landscapetools)
<span style="color:#f92672">library</span>(fasterize)
<span style="color:#f92672">library</span>(gganimate)
<span style="color:#f92672">library</span>(extrafont)</code></pre></div>
<p>extrafont allows us to use our systemfonts, later I assume that you have the Google font Mono installed. Otherwise, ggplot will fall back to a default font.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">extrafont<span style="color:#f92672">::</span>loadfonts(quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)</code></pre></div>
<h3 id="turning-polygons-in-raster">Turning polygons in raster</h3>

<p>Then, we will load timeseries data for COVID-19 on NUTS-3 level for Germany and merge it with a GADM polygon to make it spatial.
To be able to plot our spatial density lines, we have to turn our polygons into a raster. For this, we loop through each date in our dataset, make a complete dataset (fill zero cases which are NA in our data with a 0 - meaning zero cases, which is true for this type of data). We then standardize by area since some NUTS-3 regions are a lot bigger than others.</p>

<p>Lastly, we coerce our freshly cleanded polygon for each date into raster and this raster immediately into a tibble with x , y, z and time as columns. We will use the x, y and z to draw our lines and the date for the animation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># load covid and spatial data ----</span>
cov_df <span style="color:#f92672">&lt;-</span> covid19germany<span style="color:#f92672">::</span>get_RKI_timeseries()

con <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">url</span>(<span style="color:#e6db74">&#34;https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_3_sf.rds&#34;</span>)
germany_sf <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">readRDS</span>(con)

<span style="color:#75715e"># data cleaning ----</span>
<span style="color:#75715e">## clean weird naming of county names in covid dataframe</span>
cov_df<span style="color:#f92672">$</span>Landkreis <span style="color:#f92672">&lt;-</span> str_sub(cov_df<span style="color:#f92672">$</span>Landkreis, <span style="color:#ae81ff">4</span>) 

<span style="color:#75715e">## make covid data spatial </span>
germany_cov <span style="color:#f92672">&lt;-</span> left_join(germany_sf, cov_df, by <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#34;NAME_3&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Landkreis&#34;</span>))

<span style="color:#75715e">## group by date and county and summarise number of new confirmed cases</span>
germany_cov_clean <span style="color:#f92672">&lt;-</span> germany_cov <span style="color:#f92672">%&gt;%</span>
  group_by(Date, NAME_3) <span style="color:#f92672">%&gt;%</span>
  summarise(SUM <span style="color:#f92672">=</span> <span style="color:#66d9ef">sum</span>(NumberNewTestedIll))

<span style="color:#75715e"># data transformation ---</span>
spatial_data <span style="color:#f92672">&lt;-</span> map_dfr(na.omit(<span style="color:#66d9ef">unique</span>(germany_cov_clean<span style="color:#f92672">$</span>Date)), <span style="color:#66d9ef">function</span>(id_date){
  
  <span style="color:#75715e"># filter for specific date</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> germany_cov_clean <span style="color:#f92672">%&gt;%</span> 
    filter(Date <span style="color:#f92672">==</span> <span style="color:#66d9ef">as.Date</span>(id_date)) 
  
  <span style="color:#75715e"># since we only have polygons where NewIll &gt; 0, we need to join the &#34;empty&#34; ones</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">suppressWarnings</span>(st_join(germany_sf, cov_intermed))
  
  <span style="color:#75715e"># standardize by area</span>
  cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">&lt;-</span> (cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">/</span> st_area(cov_intermed))
  
  <span style="color:#75715e"># and since &#34;empty&#34; actually means 0, we are going to do this</span>
  cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">&lt;-</span> cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">%&gt;%</span> replace_na(<span style="color:#ae81ff">0</span>)
  
  <span style="color:#75715e"># turn the polygons to a raster and coerce this raster to a tibble</span>
  cov_r <span style="color:#f92672">&lt;-</span> raster(cov_intermed, res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03320453</span>)
  cov_intermed <span style="color:#f92672">&lt;-</span> fasterize(cov_intermed, cov_r, field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SUM&#34;</span>, fun<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sum&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
    landscapetools<span style="color:#f92672">::</span>util_raster2tibble()
  
  <span style="color:#75715e"># and get the naming right</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> cov_intermed <span style="color:#f92672">%&gt;%</span>
    rename(lng <span style="color:#f92672">=</span> x, lat <span style="color:#f92672">=</span>y, value <span style="color:#f92672">=</span> z) <span style="color:#75715e">#%&gt;% </span>
  
  cov_intermed<span style="color:#f92672">$</span>date <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">as.Date</span>(id_date)
  cov_intermed
  
})</code></pre></div>
<h3 id="visualize-it">Visualize it!</h3>

<h4 id="data-cleaning">Data cleaning</h4>

<p>There is something wrong with the data before the 08th of march apparently, two dates have the same numer of newly positve tested person &hellip; which causes a weird error from gganimate, so we start with this date.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">spatial_data_df <span style="color:#f92672">&lt;-</span> spatial_data <span style="color:#f92672">%&gt;%</span> 
  filter(date <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">as.Date</span>(<span style="color:#e6db74">&#34;2020-03-08&#34;</span>))</code></pre></div>
<p>We will use the five German cities Berlin, Frankfurt, Munich, Hamburg and Dortmund as points in space to give some spatial grasp to our data. Hence, we filter our sf object for Germany and repeat our data prepping steps. Lastly, we write it as a new column in our spatial_data_df object to use it later as a unique layer in our ggplot.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">aoi <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#34;Berlin&#34;</span>, <span style="color:#e6db74">&#34;Frankfurt am Main&#34;</span>, <span style="color:#e6db74">&#34;München&#34;</span>, <span style="color:#e6db74">&#34;Hamburg&#34;</span>, <span style="color:#e6db74">&#34;Dortmund&#34;</span>)

aoi_poly <span style="color:#f92672">&lt;-</span> germany_sf <span style="color:#f92672">%&gt;%</span> 
  filter(NAME_2 <span style="color:#f92672">%in%</span> aoi)

aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">&lt;-</span> aoi_poly <span style="color:#f92672">%&gt;%</span> 
  group_by(NAME_2) <span style="color:#f92672">%&gt;%</span> 
  group_indices()

aoi_poly <span style="color:#f92672">&lt;-</span> st_join(germany_sf, aoi_poly)
aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">&lt;-</span> aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">%&gt;%</span> replace_na(<span style="color:#ae81ff">0</span>)

aoi_r <span style="color:#f92672">&lt;-</span> raster(aoi_poly, res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03320453</span>)
aoi_r <span style="color:#f92672">&lt;-</span> fasterize(aoi_poly, aoi_r, field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;group_id&#34;</span>, fun <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;first&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  landscapetools<span style="color:#f92672">::</span>util_raster2tibble()

aoi_r <span style="color:#f92672">&lt;-</span> purrr<span style="color:#f92672">::</span>map_dfr(<span style="color:#66d9ef">seq_len</span>(<span style="color:#66d9ef">length</span>(<span style="color:#66d9ef">unique</span>(spatial_data_df<span style="color:#f92672">$</span><span style="color:#66d9ef">date</span>))), <span style="color:#f92672">~</span>aoi_r)

spatial_data_df<span style="color:#f92672">$</span>city <span style="color:#f92672">&lt;-</span> aoi_r<span style="color:#f92672">$</span>z</code></pre></div>
<p>We then define the colors we are going to use for our arrows indicating the position of the fice cities we specified and define the geometry of these arrows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">line_color <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#39;#fba298&#39;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>)

arrow <span style="color:#f92672">&lt;-</span> tibble(x <span style="color:#f92672">=</span>    <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">230</span>, <span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">173</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">82</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">44</span>,  <span style="color:#ae81ff">25</span>), 
                xend <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">260</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">133</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">25</span>,  <span style="color:#ae81ff">14</span>), 
                y <span style="color:#f92672">=</span>    <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">30</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">127</span>), 
                yend <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">224</span>, <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">148</span>))</code></pre></div>
<h4 id="gganimate">gganimate</h4>

<p>Turning this into a beautiful animation over time becomes now a breeze with gganimate &hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">p1 <span style="color:#f92672">&lt;-</span> ggplot(spatial_data_df, aes(lng, lat <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>(value<span style="color:#f92672">/</span><span style="color:#66d9ef">max</span>(value, na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>)))) <span style="color:#f92672">+</span>
  geom_line(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.35</span>,
            alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
            aes(group <span style="color:#f92672">=</span> lat, color <span style="color:#f92672">=</span> <span style="color:#66d9ef">factor</span>(city)),
            na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
  ggthemes<span style="color:#f92672">::</span>theme_map(base_family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  labs(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Day: {frame_time}&#39;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Shown is the number of new confirmed COVID-19 cases for each day since March, 2020.&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Visualization by Marco Sciaini • Data by RKI&#34;</span>
  ) <span style="color:#f92672">+</span>
  transition_time(<span style="color:#66d9ef">date</span>) <span style="color:#f92672">+</span>
  shadow_wake(wake_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>, colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#5A3E37&#39;</span>)  <span style="color:#f92672">+</span>
  theme(plot.background <span style="color:#f92672">=</span> element_rect(fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>, <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>),
        plot.title <span style="color:#f92672">=</span> element_text(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>), 
        plot.subtitle <span style="color:#f92672">=</span> element_text(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>)) <span style="color:#f92672">+</span>
  scale_color_manual(values <span style="color:#f92672">=</span> line_color, guide <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span>
  geom_segment(data <span style="color:#f92672">=</span> arrow, 
               aes(x <span style="color:#f92672">=</span> x, xend <span style="color:#f92672">=</span> xend, y <span style="color:#f92672">=</span> y, yend <span style="color:#f92672">=</span> yend),
               size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>,
               alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">270</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">170</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Berlin&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Munich&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Frankfurt&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dortmund&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">144</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">225</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hamburg&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>)

gganimate<span style="color:#f92672">::</span>animate(p1,
                   render <span style="color:#f92672">=</span> gifski_renderer(),
                   nframes <span style="color:#f92672">=</span> <span style="color:#66d9ef">length</span>(<span style="color:#66d9ef">unique</span>(spatial_data_df<span style="color:#f92672">$</span><span style="color:#66d9ef">date</span>)),
                   width<span style="color:#f92672">=</span> <span style="color:#ae81ff">3458</span>,
                   height<span style="color:#f92672">=</span> <span style="color:#ae81ff">3858</span>,
                   duration <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>,
                   res <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>)

anim_save(<span style="color:#e6db74">&#34;covidlines.gif&#34;</span>)</code></pre></div>
<p>Caveat: This becomes a memory monster &hellip; in late November, this was 43 gb in memory.</p>

<h4 id="ggplot">ggplot</h4>

<p>If we want to have look at specific dates, this becomes just the same chunk as above without the gganimate functions:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># plot a single day ----</span>
id_date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2020-10-05&#34;</span>

spatial_data_df <span style="color:#f92672">%&gt;%</span> 
  filter(date <span style="color:#f92672">==</span> <span style="color:#66d9ef">as.Date</span>(id_date)) <span style="color:#f92672">%&gt;%</span> 
  ggplot(aes(lng, lat <span style="color:#f92672">+</span> <span style="color:#ae81ff">25</span><span style="color:#f92672">*</span>(value<span style="color:#f92672">/</span><span style="color:#66d9ef">max</span>(value, na.rm <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)))) <span style="color:#f92672">+</span>
  geom_line(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.35</span>,
            alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
            aes(group <span style="color:#f92672">=</span> lat, color <span style="color:#f92672">=</span> <span style="color:#66d9ef">factor</span>(city)),
            na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
  ggthemes<span style="color:#f92672">::</span>theme_map(base_family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  labs(
    title <span style="color:#f92672">=</span> <span style="color:#66d9ef">paste</span>(<span style="color:#e6db74">&#34;Day:&#34;</span>, id_date), 
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Shown is the number of new confirmed COVID-19 as latitudinal density.&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Visualization by Marco Sciaini • Data by RKI&#34;</span>
  ) <span style="color:#f92672">+</span>
  theme(plot.background <span style="color:#f92672">=</span> element_rect(fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>, <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>)) <span style="color:#f92672">+</span>
  scale_color_manual(values <span style="color:#f92672">=</span> line_color, guide <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span>
  geom_segment(data <span style="color:#f92672">=</span> arrow, 
               aes(x <span style="color:#f92672">=</span> x, xend <span style="color:#f92672">=</span> xend, y <span style="color:#f92672">=</span> y, yend <span style="color:#f92672">=</span> yend),
               size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>,
               alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">270</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">170</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Berlin&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Munich&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Frankfurt&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dortmund&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">144</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">225</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hamburg&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>)

ggsave(<span style="color:#e6db74">&#34;covidlines.png&#34;</span>, width <span style="color:#f92672">=</span> <span style="color:#ae81ff">6.58</span>, height <span style="color:#f92672">=</span> <span style="color:#ae81ff">8.58</span>)</code></pre></div>
<h2 id="summary">Summary</h2>

<p>Turning COVID-19 timeseries data into a spatial animation with a strong hinche of Joy Division solely relying on R Stats tools? No problem &hellip; It is just awesome that there is an R package for everything!</p>

<p>If you have any feedback on code/visualisition - get in touch, would love to chat about it. Otherwise, here is the full code to get to the animation or static plot:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#f92672">library</span>(tidyverse)
<span style="color:#f92672">library</span>(sf)
<span style="color:#f92672">library</span>(covid19germany)
<span style="color:#f92672">library</span>(stars)
<span style="color:#f92672">library</span>(gganimate)
<span style="color:#f92672">library</span>(fasterize)
<span style="color:#f92672">library</span>(extrafont)
<span style="color:#f92672">library</span>(landscapetools)

<span style="color:#75715e"># load font ----</span>
extrafont<span style="color:#f92672">::</span>loadfonts(quiet <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)

<span style="color:#75715e"># load covid and spatial data ----</span>
cov_df <span style="color:#f92672">&lt;-</span> covid19germany<span style="color:#f92672">::</span>get_RKI_timeseries()

con <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">url</span>(<span style="color:#e6db74">&#34;https://biogeo.ucdavis.edu/data/gadm3.6/Rsf/gadm36_DEU_3_sf.rds&#34;</span>)
germany_sf <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">readRDS</span>(con)

<span style="color:#75715e"># data cleaning ----</span>
<span style="color:#75715e">## clean weird naming of county names in covid dataframe</span>
cov_df<span style="color:#f92672">$</span>Landkreis <span style="color:#f92672">&lt;-</span> str_sub(cov_df<span style="color:#f92672">$</span>Landkreis, <span style="color:#ae81ff">4</span>) 

<span style="color:#75715e">## make covid data spatial </span>
germany_cov <span style="color:#f92672">&lt;-</span> left_join(germany_sf, cov_df, by <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#34;NAME_3&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Landkreis&#34;</span>))

<span style="color:#75715e">## group by date and county and summarise number of new confirmed cases</span>
germany_cov_clean <span style="color:#f92672">&lt;-</span> germany_cov <span style="color:#f92672">%&gt;%</span>
  group_by(Date, NAME_3) <span style="color:#f92672">%&gt;%</span>
  summarise(SUM <span style="color:#f92672">=</span> <span style="color:#66d9ef">sum</span>(NumberNewTestedIll))

<span style="color:#75715e"># data transformation ---</span>
spatial_data <span style="color:#f92672">&lt;-</span> map_dfr(na.omit(<span style="color:#66d9ef">unique</span>(germany_cov_clean<span style="color:#f92672">$</span>Date)), <span style="color:#66d9ef">function</span>(id_date){
  
  <span style="color:#75715e"># filter for specific date</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> germany_cov_clean <span style="color:#f92672">%&gt;%</span> 
    filter(Date <span style="color:#f92672">==</span> <span style="color:#66d9ef">as.Date</span>(id_date)) 
  
  <span style="color:#75715e"># since we only have polygons where NewIll &gt; 0, we need to join the &#34;empty&#34; ones</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">suppressWarnings</span>(st_join(germany_sf, cov_intermed))
  
  <span style="color:#75715e"># standardize by area</span>
  cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">&lt;-</span> (cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">/</span> st_area(cov_intermed))
  
  <span style="color:#75715e"># and since &#34;empty&#34; actually means 0, we are going to do this</span>
  cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">&lt;-</span> cov_intermed<span style="color:#f92672">$</span>SUM <span style="color:#f92672">%&gt;%</span> replace_na(<span style="color:#ae81ff">0</span>)
  
  <span style="color:#75715e"># turn the polygons to a raster and coerce this raster to a tibble</span>
  cov_r <span style="color:#f92672">&lt;-</span> raster(cov_intermed, res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03320453</span>)
  cov_intermed <span style="color:#f92672">&lt;-</span> fasterize(cov_intermed, cov_r, field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SUM&#34;</span>, fun<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sum&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
    landscapetools<span style="color:#f92672">::</span>util_raster2tibble()
  
  <span style="color:#75715e"># and get the naming right</span>
  cov_intermed <span style="color:#f92672">&lt;-</span> cov_intermed <span style="color:#f92672">%&gt;%</span>
    rename(lng <span style="color:#f92672">=</span> x, lat <span style="color:#f92672">=</span>y, value <span style="color:#f92672">=</span> z) <span style="color:#75715e">#%&gt;% </span>
  
  cov_intermed<span style="color:#f92672">$</span>date <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">as.Date</span>(id_date)
  cov_intermed
  
})

<span style="color:#75715e"># animate as gif ----</span>
<span style="color:#75715e">## there is something wrong with the data before the 08th of march</span>
<span style="color:#75715e">## apparently, two dates have the same numer of newly positve tested person</span>
<span style="color:#75715e">## ... which causes a weird error from gganimate, so we start with this date</span>
spatial_data_df <span style="color:#f92672">&lt;-</span> spatial_data <span style="color:#f92672">%&gt;%</span> 
  filter(date <span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">as.Date</span>(<span style="color:#e6db74">&#34;2020-03-08&#34;</span>))


aoi <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#34;Berlin&#34;</span>, <span style="color:#e6db74">&#34;Frankfurt am Main&#34;</span>, <span style="color:#e6db74">&#34;München&#34;</span>, <span style="color:#e6db74">&#34;Hamburg&#34;</span>, <span style="color:#e6db74">&#34;Dortmund&#34;</span>)

aoi_poly <span style="color:#f92672">&lt;-</span> germany_sf <span style="color:#f92672">%&gt;%</span> 
  filter(NAME_2 <span style="color:#f92672">%in%</span> aoi)

aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">&lt;-</span> aoi_poly <span style="color:#f92672">%&gt;%</span> 
  group_by(NAME_2) <span style="color:#f92672">%&gt;%</span> 
  group_indices()

aoi_poly <span style="color:#f92672">&lt;-</span> st_join(germany_sf, aoi_poly)
aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">&lt;-</span> aoi_poly<span style="color:#f92672">$</span>group_id <span style="color:#f92672">%&gt;%</span> replace_na(<span style="color:#ae81ff">0</span>)

aoi_r <span style="color:#f92672">&lt;-</span> raster(aoi_poly, res <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03320453</span>)
aoi_r <span style="color:#f92672">&lt;-</span> fasterize(aoi_poly, aoi_r, field <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;group_id&#34;</span>, fun <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;first&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  landscapetools<span style="color:#f92672">::</span>util_raster2tibble()

aoi_r <span style="color:#f92672">&lt;-</span> purrr<span style="color:#f92672">::</span>map_dfr(<span style="color:#66d9ef">seq_len</span>(<span style="color:#66d9ef">length</span>(<span style="color:#66d9ef">unique</span>(spatial_data_df<span style="color:#f92672">$</span><span style="color:#66d9ef">date</span>))), <span style="color:#f92672">~</span>aoi_r)

spatial_data_df<span style="color:#f92672">$</span>city <span style="color:#f92672">&lt;-</span> aoi_r<span style="color:#f92672">$</span>z


line_color <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#e6db74">&#39;#fba298&#39;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>, <span style="color:#e6db74">&#34;#f84d39&#34;</span>)

arrow <span style="color:#f92672">&lt;-</span> tibble(x <span style="color:#f92672">=</span>    <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">230</span>, <span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">173</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">82</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">44</span>,  <span style="color:#ae81ff">25</span>), 
                xend <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">260</span>, <span style="color:#ae81ff">130</span>, <span style="color:#ae81ff">133</span>, <span style="color:#ae81ff">185</span>, <span style="color:#ae81ff">229</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">29</span>, <span style="color:#ae81ff">25</span>,  <span style="color:#ae81ff">14</span>), 
                y <span style="color:#f92672">=</span>    <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">160</span>, <span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">30</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">127</span>), 
                yend <span style="color:#f92672">=</span> <span style="color:#66d9ef">c</span>(<span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">170</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">224</span>, <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">84</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">148</span>))

p1 <span style="color:#f92672">&lt;-</span> ggplot(spatial_data_df, aes(lng, lat <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">*</span>(value<span style="color:#f92672">/</span><span style="color:#66d9ef">max</span>(value, na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>)))) <span style="color:#f92672">+</span>
  geom_line(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.35</span>,
            alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
            aes(group <span style="color:#f92672">=</span> lat, color <span style="color:#f92672">=</span> <span style="color:#66d9ef">factor</span>(city)),
            na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
  ggthemes<span style="color:#f92672">::</span>theme_map(base_family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  labs(
    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Day: {frame_time}&#39;</span>,
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Shown is the number of new confirmed COVID-19 cases for each day since March, 2020.&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Visualization by Marco Sciaini • Data by RKI&#34;</span>
  ) <span style="color:#f92672">+</span>
  transition_time(<span style="color:#66d9ef">date</span>) <span style="color:#f92672">+</span>
  shadow_wake(wake_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>, colour <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#5A3E37&#39;</span>)  <span style="color:#f92672">+</span>
  theme(plot.background <span style="color:#f92672">=</span> element_rect(fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>, <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>),
        plot.title <span style="color:#f92672">=</span> element_text(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">16</span>), 
        plot.subtitle <span style="color:#f92672">=</span> element_text(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>)) <span style="color:#f92672">+</span>
  scale_color_manual(values <span style="color:#f92672">=</span> line_color, guide <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span>
  geom_segment(data <span style="color:#f92672">=</span> arrow, 
               aes(x <span style="color:#f92672">=</span> x, xend <span style="color:#f92672">=</span> xend, y <span style="color:#f92672">=</span> y, yend <span style="color:#f92672">=</span> yend),
               size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>,
               alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">270</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">170</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Berlin&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Munich&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Frankfurt&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dortmund&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">144</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">225</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hamburg&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>)

gganimate<span style="color:#f92672">::</span>animate(p1,
                   render <span style="color:#f92672">=</span> gifski_renderer(),
                   nframes <span style="color:#f92672">=</span> <span style="color:#66d9ef">length</span>(<span style="color:#66d9ef">unique</span>(spatial_data_df<span style="color:#f92672">$</span><span style="color:#66d9ef">date</span>)),
                   width<span style="color:#f92672">=</span> <span style="color:#ae81ff">3458</span>,
                   height<span style="color:#f92672">=</span> <span style="color:#ae81ff">3858</span>,
                   duration <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>,
                   res <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>)

anim_save(<span style="color:#e6db74">&#34;covidlines.gif&#34;</span>)


<span style="color:#75715e"># plot a single day ----</span>
id_date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2020-10-05&#34;</span>

spatial_data_df <span style="color:#f92672">%&gt;%</span> 
  filter(date <span style="color:#f92672">==</span> <span style="color:#66d9ef">as.Date</span>(id_date)) <span style="color:#f92672">%&gt;%</span> 
  ggplot(aes(lng, lat <span style="color:#f92672">+</span> <span style="color:#ae81ff">25</span><span style="color:#f92672">*</span>(value<span style="color:#f92672">/</span><span style="color:#66d9ef">max</span>(value, na.rm <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)))) <span style="color:#f92672">+</span>
  geom_line(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.35</span>,
            alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>,
            aes(group <span style="color:#f92672">=</span> lat, color <span style="color:#f92672">=</span> <span style="color:#66d9ef">factor</span>(city)),
            na.rm<span style="color:#f92672">=</span><span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
  ggthemes<span style="color:#f92672">::</span>theme_map(base_family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  labs(
    title <span style="color:#f92672">=</span> <span style="color:#66d9ef">paste</span>(<span style="color:#e6db74">&#34;Day:&#34;</span>, id_date), 
    subtitle <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Shown is the number of new confirmed COVID-19 as latitudinal density.&#34;</span>,
    caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Visualization by Marco Sciaini • Data by RKI&#34;</span>
  ) <span style="color:#f92672">+</span>
  theme(plot.background <span style="color:#f92672">=</span> element_rect(fill <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>, <span style="color:#e6db74">&#34;#e6eaeb&#34;</span>)) <span style="color:#f92672">+</span>
  scale_color_manual(values <span style="color:#f92672">=</span> line_color, guide <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>) <span style="color:#f92672">+</span>
  geom_segment(data <span style="color:#f92672">=</span> arrow, 
               aes(x <span style="color:#f92672">=</span> x, xend <span style="color:#f92672">=</span> xend, y <span style="color:#f92672">=</span> y, yend <span style="color:#f92672">=</span> yend),
               size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>,
               alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.7</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">270</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">170</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Berlin&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">240</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">34</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Munich&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">48</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Frankfurt&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dortmund&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>) <span style="color:#f92672">+</span>
  annotate(<span style="color:#e6db74">&#34;text&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#ae81ff">144</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">225</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Hamburg&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.7</span>, family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Overpass Mono&#34;</span>)

ggsave(<span style="color:#e6db74">&#34;covidlines.png&#34;</span>, width <span style="color:#f92672">=</span> <span style="color:#ae81ff">6.58</span>, height <span style="color:#f92672">=</span> <span style="color:#ae81ff">8.58</span>)</code></pre></div>
    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Writings</a></li>
         
          <li><a href="/tags">Tags</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#background">Background</a></li>
<li><a href="#come-along">Come along!</a>
<ul>
<li><a href="#setup">Setup</a></li>
<li><a href="#turning-polygons-in-raster">Turning polygons in raster</a></li>
<li><a href="#visualize-it">Visualize it!</a>
<ul>
<li><a href="#data-cleaning">Data cleaning</a></li>
<li><a href="#gganimate">gganimate</a></li>
<li><a href="#ggplot">ggplot</a></li>
</ul></li>
</ul></li>
<li><a href="#summary">Summary</a></li>
</ul></li>
</ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&text=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&is_video=false&description=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&body=Check out this article: https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&title=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&name=Spatial%20density%20latitudinal%20lines%20for%20COVID-19&description=Background%20Inspired%20by%20James%20Cheshire%26rsquo%3bs%20Population%20Lines%20Print%20and%20Ryan%20Brideau%2c%20I%20wanted%20to%20track%20the%20spatial%20Pattern%20of%20the%20COVID-19%20in%20Germany%20over%20time.%20This%20map%20shows%20the%20density%20of%20confirmed%20cases%20COVID-19%20cases%20by%20latitude.%0aThe%20data%20comes%20from%20the%20covid19germany%20package%2c%20which%20was%20developed%20in%20the%20context%20of%20the%20%23WirvsVirus%20hackathon.%20The%20package%20loads%20the%20data%20from%20the%20Bundesamt%20f%c3%bcr%20Kartographie%20und%20Geod%c3%a4sie%20as%20well%20as%20the%20Robert%20Koch%20Institut.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmarcosci.github.io%2fposts%2f2020-12-01-latitudinaldensity%2f&t=Spatial%20density%20latitudinal%20lines%20for%20COVID-19">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Marco Sciaini 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Writings</a></li>
         
        <li><a href="/tags">Tags</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
